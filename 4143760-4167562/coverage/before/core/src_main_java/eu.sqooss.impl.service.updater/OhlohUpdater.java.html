<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>OhlohUpdater.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">JUnit (Jan 15, 2015 3:49:07 PM)</a> &gt; <a href="../../index.html" class="el_group">core</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">eu.sqooss.impl.service.updater</a> &gt; <span class="el_source">OhlohUpdater.java</span></div><h1>OhlohUpdater.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/*</span>
 * This file is part of the Alitheia system, developed by the SQO-OSS
 * consortium as part of the IST FP6 SQO-OSS project, number 033331.
 *
 * Copyright 2009 - 2010 - Organization for Free and Open Source Software,  
 *                Athens, Greece.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */

package eu.sqooss.impl.service.updater;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FilenameFilter;
import java.io.InputStream;
import java.util.Date;
import java.util.Iterator;

import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.Element;
import org.dom4j.io.SAXReader;
import org.xml.sax.EntityResolver;
import org.xml.sax.InputSource;

import eu.sqooss.service.db.OhlohDeveloper;
import eu.sqooss.service.scheduler.Job;
import eu.sqooss.service.updater.UpdaterBaseJob;
import eu.sqooss.service.util.FileUtils;

/**
 * Parses Ohloh account description files and stores them in the OhlohDeveloper
 * table, to be used for as an additional source of developer name-email matches
 * when updating our own Developer table.
 * 
 * @see &lt;a href=&quot;https://www.ohloh.net/api/reference/account&quot;&gt;Ohloh Account API&lt;/a&gt;
 * 
 * @author Georgios Gousios &lt;gousiosg@gmail.com&gt;
 */
public class OhlohUpdater extends UpdaterBaseJob {
    
    private static final String OHLOH_PATH = &quot;eu.sqooss.updater.ohloh.path&quot;;
    //private static final String OHLOH_PATH = &quot;eu.sqooss.updater.ohloh.path&quot;;
    
    private String ohlohPath;
    
<span class="nc" id="L73">    public OhlohUpdater() {</span>
<span class="nc" id="L74">        ohlohPath = System.getProperty(OHLOH_PATH); </span>
<span class="nc" id="L75">    }</span>

    @Override
    public long priority() {
<span class="nc" id="L79">        return 3;</span>
    }

    @Override
    protected void run() throws Exception {
<span class="nc" id="L84">        File f = null;</span>
        try {
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (ohlohPath == null) {</span>
<span class="nc" id="L87">                logger.error(&quot;Cannot continue without a valid path to look into&quot;);</span>
<span class="nc" id="L88">                throw new FileNotFoundException(&quot;Cannot find Ohloh XML files&quot;);</span>
            }

<span class="nc" id="L91">            f = new File(ohlohPath);</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">            if (!f.exists() || !f.isDirectory()) {</span>
<span class="nc" id="L93">                logger.error(&quot;Path&quot; + ohlohPath</span>
<span class="nc" id="L94">                        + &quot; does not exist or is not a directory&quot;);</span>
<span class="nc" id="L95">                throw new FileNotFoundException(&quot;Cannot find Ohloh XML files&quot;);</span>
            }
        } finally {
            //updater.removeUpdater(p, t);
        }
        
<span class="nc" id="L101">        String[] files = f.list(new FilenameFilter() {</span>
            public boolean accept(File dir, String name) {
<span class="nc" id="L103">                return name.endsWith(&quot;.xml&quot;);</span>
            }            
        });
        
        
<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (String file : files) {</span>
<span class="nc" id="L109">            dbs.startDBSession();</span>
            
<span class="nc" id="L111">            SAXReader reader = new SAXReader(false);</span>
<span class="nc" id="L112">            Document document = null;</span>
            
            //Dummy entity resolver to avoid downloading the bugzilla DTD from 
            //the web on parsing a bug
<span class="nc" id="L116">            EntityResolver resolver = new EntityResolver() {</span>
                public InputSource resolveEntity(String publicId, String systemId) {
<span class="nc" id="L118">                    InputStream in = new ByteArrayInputStream(&quot;&quot;.getBytes());</span>
<span class="nc" id="L119">                    return new InputSource(in);</span>
                }
            };
            
<span class="nc" id="L123">            reader.setValidation(false);</span>
<span class="nc" id="L124">            reader.setEntityResolver(resolver);</span>
<span class="nc" id="L125">            reader.setIncludeExternalDTDDeclarations(false);</span>
<span class="nc" id="L126">            reader.setIncludeInternalDTDDeclarations(false);</span>
<span class="nc" id="L127">            reader.setStripWhitespaceText(true);</span>
            
            //Parse the file
            try {
<span class="nc" id="L131">                document = reader.read(new FileReader(</span>
<span class="nc" id="L132">                        FileUtils.appendPath(f.getAbsolutePath(), file)));</span>
<span class="nc" id="L133">            } catch (FileNotFoundException fex) {</span>
<span class="nc" id="L134">                logger.warn(&quot;Cannot read file &quot; + f.getAbsolutePath() + </span>
<span class="nc" id="L135">                        fex.toString());</span>
<span class="nc" id="L136">                continue;</span>
<span class="nc" id="L137">            } catch (DocumentException e) {</span>
<span class="nc" id="L138">                logger.warn(&quot;Cannot parse Ohloh file &quot; + f.getAbsolutePath() </span>
<span class="nc" id="L139">                        + &quot; &quot; + e.getMessage());</span>
<span class="nc" id="L140">                continue;</span>
            }
            
<span class="nc" id="L143">            Element root = (Element) document.getRootElement();</span>
<span class="nc" id="L144">            Iterator i = root.element(&quot;result&quot;).elementIterator(&quot;account&quot;);</span>
            
<span class="nc bnc" id="L146" title="All 4 branches missed.">            if (i == null || !i.hasNext()) {</span>
<span class="nc" id="L147">                logger.warn(&quot;Cannot find &lt;account&gt; element in file &quot; + document.getPath());</span>
            }
            
<span class="nc bnc" id="L150" title="All 2 branches missed.">            while (i.hasNext()) {</span>
<span class="nc" id="L151">                Element account = (Element) i.next();</span>
<span class="nc" id="L152">                String id = getString(account.element(&quot;id&quot;));</span>
<span class="nc" id="L153">                String uname = getString(account.element(&quot;name&quot;));</span>
<span class="nc" id="L154">                String mailhash = getString(account.element(&quot;email_sha1&quot;));</span>
                
<span class="nc" id="L156">                OhlohDeveloper od = OhlohDeveloper.getByOhlohId(id);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                if (od != null) { //Exists, update fields to track updates</span>
<span class="nc" id="L158">                    od.setEmailHash(mailhash);</span>
<span class="nc" id="L159">                    od.setTimestamp(new Date());</span>
<span class="nc" id="L160">                    od.setUname(uname);</span>
<span class="nc" id="L161">                } else {</span>
<span class="nc" id="L162">                    od = new OhlohDeveloper(uname, mailhash, id);</span>
<span class="nc" id="L163">                    dbs.addRecord(od);</span>
                }
            }
<span class="nc" id="L166">            dbs.commitDBSession();</span>
        }
<span class="nc" id="L168">    }</span>
    
    private String getString(Element element) {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L172">            return element.getStringValue();</span>
        } else {
<span class="nc" id="L174">            return &quot;&quot;;</span>
        }
    }

    @Override
    public Job getJob() {
<span class="nc" id="L180">        return this;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>JUnit (Jan 15, 2015 3:49:07 PM)</div></body></html>