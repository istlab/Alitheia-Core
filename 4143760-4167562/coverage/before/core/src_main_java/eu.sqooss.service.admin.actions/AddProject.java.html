<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>AddProject.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">JUnit (Jan 15, 2015 3:49:07 PM)</a> &gt; <a href="../../index.html" class="el_group">core</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">eu.sqooss.service.admin.actions</a> &gt; <span class="el_source">AddProject.java</span></div><h1>AddProject.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package eu.sqooss.service.admin.actions;</span>

import java.io.File;
import java.io.FileInputStream;
import java.io.FilenameFilter;
import java.util.HashMap;
import java.util.Properties;

import eu.sqooss.core.AlitheiaCore;
import eu.sqooss.service.admin.AdminActionBase;
import eu.sqooss.service.db.ClusterNode;
import eu.sqooss.service.db.ConfigOption;
import eu.sqooss.service.db.ConfigurationOption;
import eu.sqooss.service.db.DBService;
import eu.sqooss.service.db.StoredProject;
import eu.sqooss.service.tds.BTSAccessor;
import eu.sqooss.service.tds.InvalidAccessorException;
import eu.sqooss.service.tds.InvalidRepositoryException;
import eu.sqooss.service.tds.MailAccessor;
import eu.sqooss.service.tds.ProjectAccessor;
import eu.sqooss.service.tds.TDSService;

/**
 * Action that adds a new project to the project database. 
 * 
 * &lt;h2&gt;Arguments&lt;/h2&gt;
 * 
 * &lt;table&gt;
 * &lt;th&gt;
 *  &lt;td&gt;Argument&lt;/td&gt;
 *  &lt;td&gt;Required?&lt;/td&gt;
 *  &lt;td&gt;Explanation&lt;/td&gt;
 * &lt;/th&gt;
 * 
 * &lt;tr&gt;
 *  &lt;td&gt;name&lt;/td&gt;
 *  &lt;td&gt;*&lt;/td&gt;
 *  &lt;td&gt;The name to use to reference the project&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 *  &lt;td&gt;scm&lt;/td&gt;
 *  &lt;td&gt;*&lt;/td&gt;
 *  &lt;td&gt;The URL for the project's SCM system&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 *  &lt;td&gt;dir&lt;/td&gt;
 *  &lt;td&gt;&lt;/td&gt;
 *  &lt;td&gt;Directory that contains the project, in the Alitheia Core expected layout. 
 *      If the action finds this argument it ignores all others.&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 *  &lt;td&gt;update&lt;/td&gt;
 *  &lt;td&gt;&lt;/td&gt;
 *  &lt;td&gt;Its presence controls whether a data update will be triggered after the project has been
 *  succesfully installed.&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;/table&gt;
 * 
 * @author gousiosg
 *
 */
<span class="nc" id="L62">public class AddProject extends AdminActionBase {</span>

	public static final String MNEMONIC = &quot;addpr&quot;;
	
    Properties p;
    
    @Override
    public String mnemonic() {
<span class="nc" id="L70">        return MNEMONIC;</span>
    }

    @Override
    public String descr() {
<span class="nc" id="L75">        return &quot;Adds a project to the database&quot;;</span>
    }

    @Override
    public void execute() throws Exception {
<span class="nc" id="L80">        super.execute();</span>
<span class="nc" id="L81">        String name = null, bts = null, scm = null, mail = null, contact = null, web = null;</span>
<span class="nc" id="L82">        DBService db = AlitheiaCore.getInstance().getDBService();</span>
<span class="nc" id="L83">        TDSService tds = AlitheiaCore.getInstance().getTDSService();</span>
        
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (args.containsKey(&quot;dir&quot;)) { </span>
<span class="nc" id="L86">            addProjectDir(args.get(&quot;dir&quot;).toString());</span>
            
<span class="nc" id="L88">            name = p.getProperty(ConfigOption.PROJECT_NAME.getName());</span>
<span class="nc" id="L89">            bts = p.getProperty(ConfigOption.PROJECT_BTS_URL.getName());</span>
<span class="nc" id="L90">            scm = p.getProperty(ConfigOption.PROJECT_SCM_URL.getName());</span>
<span class="nc" id="L91">            mail = p.getProperty(ConfigOption.PROJECT_ML_URL.getName());</span>
<span class="nc" id="L92">            contact = p.getProperty(ConfigOption.PROJECT_CONTACT.getName());</span>
<span class="nc" id="L93">            web = p.getProperty(ConfigOption.PROJECT_WEBSITE.getName());</span>
<span class="nc" id="L94">        } else {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            name = (args.get(&quot;name&quot;) == null)?&quot;&quot;:args.get(&quot;name&quot;).toString();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            bts = (args.get(&quot;bts&quot;) == null)?&quot;&quot;:args.get(&quot;bts&quot;).toString();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            scm = (args.get(&quot;scm&quot;) == null)?&quot;&quot;:args.get(&quot;scm&quot;).toString();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            mail = (args.get(&quot;mail&quot;) == null)?&quot;&quot;:args.get(&quot;mail&quot;).toString();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            contact = (args.get(&quot;contact&quot;) == null)?&quot;&quot;:args.get(&quot;contact&quot;).toString();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            web = (args.get(&quot;web&quot;) == null)?&quot;&quot;:args.get(&quot;web&quot;).toString();</span>
            
<span class="nc" id="L102">            p = new Properties();</span>
<span class="nc" id="L103">            p.put(ConfigOption.PROJECT_NAME.getName(), name);</span>
<span class="nc" id="L104">            p.put(ConfigOption.PROJECT_WEBSITE.getName(), web);</span>
<span class="nc" id="L105">            p.put(ConfigOption.PROJECT_CONTACT.getName(), contact);</span>
<span class="nc" id="L106">            p.put(ConfigOption.PROJECT_BTS_URL.getName(), bts);</span>
<span class="nc" id="L107">            p.put(ConfigOption.PROJECT_ML_URL.getName(), mail);</span>
<span class="nc" id="L108">            p.put(ConfigOption.PROJECT_SCM_URL.getName(), scm);</span>
        }

        // Avoid missing-entirely kinds of parameters.
<span class="nc bnc" id="L112" title="All 4 branches missed.">        if ( (name == null) || (scm == null) ) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            error(&quot;missing.param&quot;, &quot;Missing required parameter &quot; + ((name == null)?&quot;name&quot;:&quot;scm&quot;));</span>
        }

        // Avoid adding projects with empty names or SVN.
<span class="nc bnc" id="L117" title="All 4 branches missed.">        if (name.trim().length() == 0 || scm.trim().length() == 0) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            error(&quot;missing.param&quot;, &quot;Missing required parameter &quot; + ((name.length() == 0)?&quot;name&quot;:&quot;scm&quot;));</span>
        }

        /* Run a few checks before actually storing the project */
        // 1. Duplicate project
<span class="nc" id="L123">        HashMap&lt;String, Object&gt; props = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L124">        props.put(&quot;name&quot;,  name);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!db.findObjectsByProperties(StoredProject.class, props).isEmpty()) {</span>
<span class="nc" id="L126">            error(&quot;project.exists&quot;, &quot;A project with the same name already exists&quot;);</span>
        }

        // 2. Check for data handlers Add accessor and try to access project resources
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!tds.isURLSupported(scm)) {</span>
<span class="nc" id="L131">            error(&quot;tds.unsupported.url&quot;, &quot;No appropriate accessor for repository URI: &quot;+ scm);</span>
        }
        
<span class="nc bnc" id="L134" title="All 6 branches missed.">        if (mail != null &amp;&amp;  !mail.isEmpty() &amp;&amp; !tds.isURLSupported(mail)) {</span>
<span class="nc" id="L135">             error(&quot;tds.unsupported.url&quot;, &quot;No appropriate accessor for repository URI: &quot;+ mail);</span>
        }
        
<span class="nc bnc" id="L138" title="All 6 branches missed.">        if (bts != null &amp;&amp; !bts.isEmpty() &amp;&amp; !tds.isURLSupported(bts)) {</span>
<span class="nc" id="L139">            error(&quot;tds.unsupported.url&quot;, &quot;No appropriate accessor for repository URI: &quot;+ bts);</span>
        }

<span class="nc" id="L142">        tds.addAccessor(Integer.MAX_VALUE, name, bts, mail, scm);</span>
        
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (tds.getAccessor(Integer.MAX_VALUE) == null)</span>
<span class="nc" id="L145">        	warn(&quot;tds&quot;, &quot;Error retrieving accessor for project: &quot; + name);</span>
        
<span class="nc" id="L147">        ProjectAccessor a = tds.getAccessor(Integer.MAX_VALUE);</span>
        
        try {
<span class="nc" id="L150">        	debug(&quot;Testing SCM accessor for project: &quot; + name);</span>
<span class="nc" id="L151">            a.getSCMAccessor().getHeadRevision();</span>
<span class="nc" id="L152">            debug(&quot;SCM accessor OK. SCM Head: &quot; + </span>
<span class="nc" id="L153">            		a.getSCMAccessor().getHeadRevision().getUniqueId());</span>
            
<span class="nc" id="L155">            debug(&quot;Testing BTS accessor for project: &quot; + name);</span>
<span class="nc" id="L156">            BTSAccessor ba = a.getBTSAccessor();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (ba == null) {</span>
<span class="nc" id="L158">                warn(&quot;tds.bts.url&quot;, &quot;Bug Accessor failed initialization for URI:&quot; + bts);</span>
<span class="nc" id="L159">            } else {</span>
<span class="nc" id="L160">            	debug(&quot;BTS accessor OK.&quot;);</span>
            }

<span class="nc" id="L163">            debug(&quot;Testing mail accessor for project: &quot; + name);</span>
<span class="nc" id="L164">            MailAccessor ma = a.getMailAccessor();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (ma == null) {</span>
<span class="nc" id="L166">                warn(&quot;tds.mail.maildir&quot;, &quot;Mail accessor failed initialization for URI:&quot; + bts);</span>
<span class="nc" id="L167">            } else {</span>
<span class="nc" id="L168">            	debug(&quot;Mail accessor OK.&quot;);</span>
            }
<span class="nc" id="L170">        } catch (InvalidRepositoryException ire) {</span>
<span class="nc" id="L171">            error(&quot;tds.scm.url&quot;, &quot;No appropriate accessor for repository URI: &quot;+ scm);</span>
<span class="nc" id="L172">        } catch (InvalidAccessorException iae) {</span>
<span class="nc" id="L173">            error(&quot;tds&quot;, &quot;Invalid accessor: &quot;+ iae.getAccessorURI());</span>
<span class="nc" id="L174">        } catch (Exception e) {</span>
<span class="nc" id="L175">        	error(&quot;tds&quot;, &quot;Accessor failed: &quot;+ e.getMessage());</span>
<span class="nc" id="L176">        } finally {</span>
<span class="nc" id="L177">            tds.releaseAccessor(a);</span>
<span class="nc" id="L178">        }</span>
        
<span class="nc" id="L180">        StoredProject sp = new StoredProject(name);</span>
        //The project is now ready to be added 
<span class="nc" id="L182">        db.addRecord(sp);</span>
        
        //Store all known properties to the database
<span class="nc bnc" id="L185" title="All 2 branches missed.">        for (ConfigOption co : ConfigOption.values()) {</span>
<span class="nc" id="L186">            String s = p.getProperty(co.getName());</span>
            
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (s == null)</span>
<span class="nc" id="L189">                continue;</span>
            
            //Don't split URLs
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (co.equals(ConfigOption.PROJECT_BTS_URL) ||</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            		co.equals(ConfigOption.PROJECT_ML_URL) ||</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            		co.equals(ConfigOption.PROJECT_SCM_URL)) {</span>
<span class="nc" id="L195">            	sp.addConfig(co, s);</span>
<span class="nc" id="L196">            	continue;</span>
            }

<span class="nc" id="L199">            String[] subopts = s.split(&quot; &quot;);</span>
            
<span class="nc bnc" id="L201" title="All 2 branches missed.">            for (String subopt : subopts) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (subopt.trim().length() &gt; 0)</span>
<span class="nc" id="L203">                    sp.addConfig(co, subopt.trim());</span>
            }
        }
       
<span class="nc" id="L207">        tds.addAccessor(sp.getId(), sp.getName(), sp.getBtsUrl(), sp.getMailUrl(), </span>
<span class="nc" id="L208">                sp.getScmUrl());</span>

<span class="nc" id="L210">        sp.setClusternode(ClusterNode.thisNode());</span>
        
<span class="nc" id="L212">        log(&quot;Added a new project &lt;&quot; + name + &quot;&gt; with ID &quot; + sp.getId());</span>
        
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (args.get(&quot;update&quot;) != null)</span>
<span class="nc" id="L215">            AlitheiaCore.getInstance().getUpdater().update(sp);</span>
        
<span class="nc" id="L217">        finished(&quot;Project addded succesfully&quot;);</span>
<span class="nc" id="L218">    }</span>
    
    private void addProjectDir(String info) throws Exception {
        
<span class="nc bnc" id="L222" title="All 4 branches missed.">        if (info == null || info.length() == 0) {</span>
<span class="nc" id="L223">            error(&quot;missing.param&quot;, &quot;Missing required parameter path: &quot; + info);</span>
        }
        
<span class="nc" id="L226">        File infoFile = new File(info);</span>
        
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (!infoFile.exists()) {</span>
<span class="nc" id="L229">            error(&quot;missing.path&quot;, &quot;The provided path does not exist&quot;);</span>
        }
        
<span class="nc" id="L232">        File f = null;</span>
        
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (infoFile.isDirectory()) {</span>
<span class="nc" id="L235">            File[] contents = infoFile.listFiles(new FilenameFilter() {</span>
                
                @Override
                public boolean accept(File dir, String name) {
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    if (name.contentEquals(&quot;project.properties&quot;))</span>
<span class="nc" id="L240">                        return true;</span>
<span class="nc" id="L241">                    return false;</span>
                }
            });
        
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (contents.length &lt;= 0) {</span>
<span class="nc" id="L246">                error(&quot;missing.project.properties&quot;, &quot;The provided directory does not include a project.properties file&quot;);</span>
            }
            
<span class="nc" id="L249">            f = contents[0];</span>
            
<span class="nc" id="L251">        } else {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (!info.endsWith(&quot;project.properties&quot;)) {</span>
<span class="nc" id="L253">                error(&quot;missing.project.properties&quot;, &quot;The provided directory does not include a project.properties file&quot;);</span>
            }
<span class="nc" id="L255">            f = infoFile;</span>
        }

<span class="nc" id="L258">        p = new Properties();</span>
        try {
<span class="nc" id="L260">            p.load(new FileInputStream(f));</span>
<span class="nc" id="L261">        } catch (Exception e1) {</span>
<span class="nc" id="L262">            error(&quot;not.properties&quot;, &quot;The provided path is not a valid project.properties file&quot;);</span>
        }

<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (p.getProperty(ConfigOption.PROJECT_NAME.getName()) == null)</span>
<span class="nc" id="L266">            p.setProperty(ConfigOption.PROJECT_NAME.getName(), f.getParentFile().getName());</span>

<span class="nc" id="L268">        String parent = f.getParentFile().getAbsolutePath();</span>
<span class="nc" id="L269">        debug(&quot;Project dir URI: &quot; + f.getParentFile().toURI());</span>
        
<span class="nc" id="L271">        p.setProperty(ConfigOption.PROJECT_BTS_URL.getName(),</span>
<span class="nc" id="L272">                &quot;bugzilla-xml:///&quot; + parent + File.separator + &quot;bugs&quot;);</span>
<span class="nc" id="L273">        p.setProperty(ConfigOption.PROJECT_ML_URL.getName(), </span>
<span class="nc" id="L274">                &quot;maildir:///&quot; + parent + File.separator + &quot;mail&quot;);</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">        for (File file: infoFile.listFiles()) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (!file.isDirectory())</span>
<span class="nc" id="L278">                continue;</span>
            
<span class="nc bnc" id="L280" title="All 2 branches missed.">            if(file.getName().equals(&quot;svn&quot;)) {</span>
<span class="nc" id="L281">                p.setProperty(ConfigOption.PROJECT_SCM_URL.getName(),</span>
<span class="nc" id="L282">                        &quot;svn-file:///&quot; + parent + File.separator +&quot;svn&quot;);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            } else if (file.getName().equals(&quot;git&quot;)) {</span>
<span class="nc" id="L284">                p.setProperty(ConfigOption.PROJECT_SCM_URL.getName(),</span>
<span class="nc" id="L285">                        &quot;git-file:///&quot; + parent + File.separator + &quot;git&quot;);</span>
            }
        }
<span class="nc" id="L288">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>JUnit (Jan 15, 2015 3:49:07 PM)</div></body></html>